<!DOCTYPE html>
<html>
<head>
<title>Transit Test</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
<!--Copyright Â© 2016 Michael Schade, http://mvjantzen.com -->
<style type="text/css">
html {
  height: 100%;
  }
body {
  height: 100%;
  margin: 0;
  padding: 0;
  font-family: verdana, sans-serif;
  }
td, th {
  text-align: right;
  }
#control {
  color: #000000;
  background-color: rgba(204, 204, 204, 0.8);
  padding: 4px 4px;
  position: absolute;
  line-height: 97%;
  top: 0;
  left: 0;
  font-size: 85%;
  max-width: 400px;
  }
#map_canvas {
  height: 100%
  }
</style>
</head>
<script>
var map;
var infowindow;

function initialize() {
  var styles = [
    {stylers: [{gamma: 1}]},
    {featureType: "all",                     elementType: "labels",          stylers: [{visibility: "off"}]},
    {featureType: "road",                    elementType: "geometry",        stylers: [{visibility: "simplified"}, {color: "#FFFFFF"}]},
    {featureType: "water",                   elementType: "geometry",        stylers: [{color: "#9A9AFF"}]},
    {featureType: "transit",                 elementType: "geometry",        stylers: [{color: "#FFFF9A"}]},
    {featureType: "landscape",               elementType: "geometry",        stylers: [{color: "#9AD9E8"}]},
    {featureType: "poi",                     elementType: "geometry",        stylers: [{color: "#9AD9E8"}]},
    {featureType: "transit.station.airport", elementType: "geometry.fill",   stylers: [{color: "#9AD9E8"}]}
    ];
  var mapOptions = {
    zoom: 11,
    panControl: false,
    scrollwheel: false,
    streetViewControl: false,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    mapTypeControlOptions: {
      style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
      position: google.maps.ControlPosition.TOP_RIGHT
      },
    styles: styles
    }
  map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
  map.setCenter(new google.maps.LatLng(38.889805, -77.036560));
  var bounds = new google.maps.LatLngBounds();
  bounds.extend(new google.maps.LatLng(38.88599, -77.15629));  // EFC
  bounds.extend(new google.maps.LatLng(38.89660, -77.07146));  // Rosslyn
  infowindow = new google.maps.InfoWindow({disableAutoPan: true});
  map.fitBounds(bounds);
  document.getElementById('control').onmouseover = function() {infowindow.close();};
  }

function get(url) {
  return new Promise(function(resolve, reject) {
    var req = new XMLHttpRequest();
    req.open('GET', url);
    req.onload = function() {
      if (req.status == 200) { resolve(req.response); }
      else                   { reject(Error(req.statusText)); }
      };
    req.onerror = function() {
      reject(Error("Network Error"));
      };
    req.send();
    });
  }

function parseResponse(response) {
  var obj = JSON.parse(response);
  var feeds = obj.feeds;
  var ul = document.getElementById("systemList");
  for (var i = 0; i < feeds.length; i++) {
    console.log(feeds[i].onestop_id)
    var li = document.createElement("li");
    li.appendChild(document.createTextNode(feeds[i].onestop_id));
    ul.appendChild(li);
    }
  }

function findTransit() {
  var bounds = map.getBounds();
  var ne = bounds.getNorthEast();
  var sw = bounds.getSouthWest();
  var url = "https://transit.land/api/v1/feeds?bbox=" + sw.lng() + "," + sw.lat() + "," + ne.lng() + "," + ne.lat();
  console.log("querying " + url);
  get(url)
    .then(parseResponse,
          function(error) {console.error("Failed!", error);});
  }
</script>
<body>
<div id=map_canvas ></div>
<div id=control >
  <button onclick="findTransit()">Find Transit</button><br>
  <ul id="systemList"></ul>
  </div>
<script src="https://maps.googleapis.com/maps/api/js?callback=initialize" async defer></script>
</body>
</html>
