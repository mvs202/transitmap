<!DOCTYPE html>
<html>
<head>
<title>Transit Test</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
<!--Copyright Â© 2016 Michael Schade, http://mvjantzen.com -->
<style type="text/css">
html {
  height: 100%;
  }
body {
  height: 100%;
  margin: 0;
  padding: 0;
  font-family: verdana, sans-serif;
  }
ul {
  margin-left: 0;
  padding-left: 0;
  list-style: none;
  }
li {
  background-color: #FFFFFF;
  transition: all 3s ease;
  }
label {
  color: #656565;
  }
#control {
  color: #000000;
  background-color: rgba(204, 204, 204, 0.67);
  padding: 4px 4px;
  position: absolute;
  line-height: 97%;
  top: 0;
  left: 0;
  font-size: 85%;
  max-width: 400px;
  }
#map_canvas {
  height: 100%
  }
</style>
</head>
<script>
var map;
var infowindow;
var knownOperators = [];
var operatorInfo = [];

function initialize() {
  var styles = [
    {stylers: [{gamma: 1}]},
    {featureType: "all",                     elementType: "labels",          stylers: [{visibility: "off"}]},
    {featureType: "road",                    elementType: "geometry",        stylers: [{visibility: "simplified"}, {color: "#FFFFFF"}]},
    {featureType: "water",                   elementType: "geometry",        stylers: [{color: "#9A9AFF"}]},
    {featureType: "transit",                 elementType: "geometry",        stylers: [{color: "#FFFF9A"}]},
    {featureType: "landscape",               elementType: "geometry",        stylers: [{color: "#9AD9E8"}]},
    {featureType: "poi",                     elementType: "geometry",        stylers: [{color: "#9AD9E8"}]},
    {featureType: "transit.station.airport", elementType: "geometry.fill",   stylers: [{color: "#9AD9E8"}]}
    ];
  var mapOptions = {
    zoom: 11,
    panControl: false,
    scrollwheel: false,
    streetViewControl: false,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    mapTypeControlOptions: {
      style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
      position: google.maps.ControlPosition.TOP_RIGHT
      },
    styles: styles
    }
  map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
  map.setCenter(new google.maps.LatLng(38.889805, -77.036560));
  var bounds = new google.maps.LatLngBounds();
  bounds.extend(new google.maps.LatLng(38.88599, -77.15629));  // EFC
  bounds.extend(new google.maps.LatLng(38.89660, -77.07146));  // Rosslyn
  infowindow = new google.maps.InfoWindow({disableAutoPan: true});
  map.fitBounds(bounds);
  document.getElementById('control').onmouseover = function() {infowindow.close();};
  }

function get(url) {
  return new Promise(function(resolve, reject) {
    var req = new XMLHttpRequest();
    req.open('GET', url);
    req.onload = function() {
      if (req.status == 200) { resolve(req.response); }
      else                   { reject(Error(req.statusText)); }
      };
    req.onerror = function() {
      reject(Error("Network Error"));
      };
    req.send();
    });
  }

function parseOperators(response) {
  var obj = JSON.parse(response);
  var operators = obj.operators;
  var ul = document.getElementById("systemList");
  for (var i = 0; i < operators.length; i++) {
    console.log(operators[i])
    var id = operators[i].onestop_id;
    if (knownOperators.indexOf(id) < 0) {  // add new operator!
      knownOperators.push(id);
      var li = document.createElement("li");
      li.id = id + "-li";
      var operatorName = operators[i].short_name;
      if (operatorName == null) {
        operatorName = operators[i].name;
        }
      li.appendChild(document.createTextNode(operatorName));
      ul.appendChild(li);
      var checkbox = document.createElement('input');
      checkbox.type = "checkbox";
      checkbox.id = id;
      var label = document.createElement('label')
      label.htmlFor = id;
      var routeButtonLabel = document.createTextNode('routes');
      label.appendChild(routeButtonLabel);
      li.appendChild(checkbox);
      li.appendChild(label);
      window.getComputedStyle(li).backgroundColor;  // ensure default color is set
      li.style.backgroundColor = "transparent";  // will fade from default color
      var operatorObj = {
        id: id,
        routeButtonLabel: routeButtonLabel
        };
      operatorInfo.push(operatorObj);  // need to store in array...?  :P
      checkbox.onclick = toggleRoutesFunction(operatorObj);
      }
    }
  }

function parseRoutes(response, operatorObj) {
  var obj = JSON.parse(response);
  var routes = obj.routes;
  if (routes.length == 1) {
    operatorObj.routeButtonLabel.nodeValue = "1 route";
    }
  else {
    operatorObj.routeButtonLabel.nodeValue = routes.length + " routes";
    }
  operatorObj.polylines = [];
  for (var i = 0; i < routes.length; i++) {
    var coordinates = routes[i].geometry.coordinates;
    for (var j = 0; j < coordinates.length; j++) {
      var segment = coordinates[j];
      var polyline = [];
      for (var k = 0; k < segment.length; k++) {
        //console.log({lat: segment[j][1], lng: segment[j][0]});
        polyline.push({lat: segment[k][1], lng: segment[k][0]});
        }
      operatorObj.polylines.push(new google.maps.Polyline({
        path: polyline,
        geodesic: true,
        strokeColor: '#FF6565',
        strokeOpacity: 1.0,
        strokeWeight: 2,
        map: map
        }));
      }
    }
  }

function toggleRoutesFunction(operatorObj) {
  return function(event) {
    if (this.checked) {
      if (operatorObj.polylines) {
        for (var i = 0; i < operatorObj.polylines.length; i++) {
          operatorObj.polylines[i].setMap(map);
          }
        }
      else {
        operatorObj.routeButtonLabel.nodeValue = "waiting...";
        var url = "http://transit.land/api/v1/routes?operated_by=" + operatorObj.id + "&per_page=1000";
        console.log("querying " + url);
        get(url)
          .then(function(response) {parseRoutes(response, operatorObj);},
                function(error)    {console.error("Failed!", error);});
        }
      }
    else {
      for (var i = 0; i < operatorObj.polylines.length; i++) {
        operatorObj.polylines[i].setMap(null);
        }
      }
    };
  }

function findTransit() {
  var bounds = map.getBounds();
  var ne = bounds.getNorthEast();
  var sw = bounds.getSouthWest();
  var url = "https://transit.land/api/v1/operators?bbox=" + sw.lng() + "," + sw.lat() + "," + ne.lng() + "," + ne.lat() + "&total=true";
  console.log("querying " + url);
  get(url)
    .then(parseOperators,
          function(error) {console.error("Failed!", error);});
  }
</script>
<body>
<div id=map_canvas ></div>
<div id=control >
  <button onclick="findTransit()">Find transit operators in map</button><br>
  <ul id="systemList"></ul>
  </div>
<script src="https://maps.googleapis.com/maps/api/js?callback=initialize" async defer></script>
</body>
</html>
