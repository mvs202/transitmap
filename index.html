<!DOCTYPE html>
<html>
<head>
<title>Demo of transit.land API</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
<base target="_blank">
<!--Copyright Â© 2016 Michael Schade, http://mvjantzen.com -->
<!-- https://github.com/mvs202/transitmap -->
<style type="text/css">
html {
  height: 100%;
  }
body {
  height: 100%;
  margin: 0;
  padding: 0;
  font-family: verdana, sans-serif;
  }
ul {
  margin-left: 0;
  padding-left: 0;
  list-style: none;
  }
li {
  background-color: #FFFFFF;
  transition: all 3s ease;
  }
label {
  color: #656565;
  }
a {
  color: #000000;
  text-decoration: none;
  transition: all 0.5s ease;
  }
a:hover {
  background-color: #FFFFFF;
  }
#control {
  color: #000000;
  background-color: rgba(204, 204, 204, 0.67);
  padding: 4px 4px;
  position: absolute;
  line-height: 97%;
  top: 0;
  left: 0;
  font-size: 85%;
  max-width: 400px;
  }
#map_canvas {
  height: 100%
  }
</style>
</head>
<script>
var map;
var infowindow;
var knownOperators = [];
var operatorList = {};  // associative array, indexed by "onestop_id" for operators
var routeList = {};  // associative array, indexed by "onestop_id" for routes

function initialize() {
  var styles = [
    {stylers: [{gamma: 1}]},
    {featureType: "all",                     elementType: "labels",          stylers: [{visibility: "off"}]},
    {featureType: "road",                    elementType: "geometry",        stylers: [{visibility: "simplified"}, {color: "#FFFFFF"}]},
    {featureType: "water",                   elementType: "geometry",        stylers: [{color: "#9A9AFF"}]},
    {featureType: "transit",                 elementType: "geometry",        stylers: [{color: "#9AFFFF"}]},
    {featureType: "landscape",               elementType: "geometry",        stylers: [{color: "#9AD9E8"}]},
    {featureType: "poi",                     elementType: "geometry",        stylers: [{color: "#9AD9E8"}]},
    {featureType: "transit.station.airport", elementType: "geometry.fill",   stylers: [{color: "#9AD9E8"}]}
    ];
  var mapOptions = {
    center: new google.maps.LatLng(38.8895, -77.0352),
    zoom: 11,
    panControl: false,
    scrollwheel: false,
    streetViewControl: false,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    mapTypeControlOptions: {
      style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
      position: google.maps.ControlPosition.TOP_RIGHT
      },
    styles: styles
    }
  map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
  infowindow = new google.maps.InfoWindow({disableAutoPan: true});
  document.getElementById('control').onmouseover = function() {infowindow.close();};
  var geoSuccess = function(position) {
    map.setCenter(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
    };
  navigator.geolocation.getCurrentPosition(geoSuccess);
  }

function get(url) {
  return new Promise(function(resolve, reject) {
    var req = new XMLHttpRequest();
    req.open('GET', url);
    req.onload = function() {
      if (req.status == 200) { resolve(req.response); }
      else                   { reject(Error(req.statusText)); }
      };
    req.onerror = function() {
      reject(Error("Network Error"));
      };
    req.send();
    });
  }

function parseOperators(response) {
  var obj = JSON.parse(response);
  var operators = obj.operators;
  var ul = document.getElementById("systemList");
  for (var i = 0; i < operators.length; i++) {
    var id = operators[i].onestop_id;
    if (knownOperators.indexOf(id) < 0) {  // add new operator!
      knownOperators.push(id);
      var li = document.createElement("li");
      li.id = id + "-li";
      var operatorName = operators[i].short_name;
      if (operatorName == null) {
        operatorName = operators[i].name;
        }
      li.appendChild(document.createTextNode(operatorName));
      ul.appendChild(li);
      var checkbox = document.createElement('input');
      checkbox.type = "checkbox";
      checkbox.id = id;
      var label = document.createElement('label')
      label.htmlFor = id;
      var routeButtonLabel = document.createTextNode('routes');
      label.appendChild(routeButtonLabel);
      li.appendChild(checkbox);
      li.appendChild(label);
      window.getComputedStyle(li).backgroundColor;  // ensure default color is set
      li.style.backgroundColor = "transparent";  // will fade from default color
      checkbox.onclick = toggleOperatorFunction(id);
      operatorList[id] = {
        routeButtonLabel: routeButtonLabel
        };
      }
    }
  document.getElementById("button").disabled = false;
  }

function parseRoutes(response, operatorObj) {
  var obj = JSON.parse(response);
  var routes = obj.routes;
  if (routes.length == 1) {
    operatorObj.routeButtonLabel.nodeValue = "1 route";
    }
  else {
    operatorObj.routeButtonLabel.nodeValue = routes.length + " routes";
    }
  operatorObj.polylines = [];
  for (var i = 0; i < routes.length; i++) {
    var routesArray = [];
    var coordinates = routes[i].geometry.coordinates;
    var bounds = new google.maps.LatLngBounds();
    for (var j = 0; j < coordinates.length; j++) {
      var segment = coordinates[j];
      var polyline = [];
      for (var k = 0; k < segment.length; k++) {
        var lat = segment[k][1];
        var lng = segment[k][0];
        polyline.push({lat: lat, lng: lng});
        bounds.extend(new google.maps.LatLng(lat, lng));
        }
      var p = new google.maps.Polyline({
        path: polyline,
        geodesic: true,
        strokeColor: '#FF6565',
        strokeOpacity: 0.8,
        strokeWeight: 2,
        map: map
        });
      routesArray.push(p);
      operatorObj.polylines.push(p);
      google.maps.event.addListener(p, 'mouseover', routeInfoFunction(routes[i]));
      }
    routeList[routes[i].onestop_id] = {
      routes: routesArray,
      bounds: bounds,
      highlighted: false
      };
    }
  }

function highlightRoute(inputTag) {
  var polyline = routeList[inputTag.value];
  if (polyline) {  // property found
    if (inputTag.checked) {
      var options = {strokeColor: '#FFFF65', strokeOpacity: 1.0, strokeWeight: 6};
      }
    else {
      var options = {strokeColor: '#FF6565', strokeOpacity: 0.8, strokeWeight: 2};
      }
    for (var i = 0; i < polyline.routes.length; i++) {
      polyline.routes[i].setOptions(options);
      }
    polyline.highlighted = inputTag.checked;
    }
  else {  // route is undefined
    console.log("Can't find route " + inputTag.value);
    }
  }

function routeInfoFunction(route) {
  return function(event) {
    var polyline = routeList[route.onestop_id];
    if (polyline && polyline.highlighted) {
      var isChecked = "checked ";
      }
    else {
      var isChecked = "";
      }
    var content =
      route.operated_by_name + "<br>" +
      route.name + " (" + route.vehicle_type + ")<br>" +
      "<label><input type=checkbox " + isChecked + "value='" + route.onestop_id + "' onclick='highlightRoute(this)'>highlight</label><br>" +
      "<label><input type=checkbox >show stops</label><br>" +
      "<button onclick=zoomToRoute('" + route.onestop_id + "')>zoom to route</button>";
    infowindow.setContent(content);
    infowindow.setPosition(event.latLng);
    infowindow.open(map);
    }
  }

function zoomToRoute(routeID) {
  map.fitBounds(routeList[routeID].bounds);
  }

function toggleOperatorFunction(id) {
  return function(event) {
    var operatorObj = operatorList[id];
    if (this.checked) {
      if (operatorObj.polylines) {  // show routes
        for (var i = 0; i < operatorObj.polylines.length; i++) {
          operatorObj.polylines[i].setMap(map);
          }
        }
      else {  // find and display routes
        operatorObj.routeButtonLabel.nodeValue = "waiting...";
        var url = "http://transit.land/api/v1/routes?operated_by=" + id + "&per_page=1000";
        console.log("querying " + url);
        get(url)
          .then(function(response) {
            operatorObj.routeButtonLabel.nodeValue = "drawing...";parseRoutes(response, operatorObj);},
                function(error)    {console.error("Failed!", error);});
        }
      }
    else {  // hide routes
      for (var i = 0; i < operatorObj.polylines.length; i++) {
        operatorObj.polylines[i].setMap(null);
        }
      }
    }
  }

function findTransit() {
  document.getElementById("button").disabled = true;
  var bounds = map.getBounds();
  var ne = bounds.getNorthEast();
  var sw = bounds.getSouthWest();
  var url = "https://transit.land/api/v1/operators?bbox=" + sw.lng() + "," + sw.lat() + "," + ne.lng() + "," + ne.lat() + "&total=true";
  console.log("querying " + url);
  get(url)
    .then(parseOperators,
          function(error) {
            document.getElementById("button").disabled = false;
            console.error("Failed!", error);
            });
  }
</script>
<body>
<div id=map_canvas ></div>
<div id=control >
  Demo of <a href="https://transit.land/">transit.land</a> API<br>
  <button id="button" onclick="findTransit()">Find transit operators in map</button><br>
  <ul id="systemList"></ul>
  </div>
<script src="https://maps.googleapis.com/maps/api/js?callback=initialize&key=AIzaSyAC2Gly8X2mFKSRkUrwLKMWQvUYS54QhsA" async defer></script>
</body>
</html>
